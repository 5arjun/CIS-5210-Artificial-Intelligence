name: Process Handwritten Notes

on:
  push:
    paths:
      - 'notes-inbox/**'
    branches:
      - main

jobs:
  process-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies for HEIF
      run: |
        sudo apt-get update
        sudo apt-get install -y libheif-dev libde265-dev
    
    - name: Install dependencies
      run: |
        pip install -r scripts/requirements.txt

    - name: Install dependencies
      run: |
        pip install -r scripts/requirements.txt
    
    - name: Configure Google Cloud credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_VISION_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > /tmp/google-creds.json
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/google-creds.json
    
    - name: Validate images
      id: validate
      run: |
        python scripts/validate_images.py
      continue-on-error: true
    
    - name: Process OCR
      id: ocr
      env:
        GOOGLE_APPLICATION_CREDENTIALS: /tmp/google-creds.json
      run: |
        python scripts/ocr_processor.py > /tmp/ocr_output.json
    
    - name: Format to Markdown
      id: format
      env:
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
      run: |
        python scripts/markdown_formatter.py /tmp/ocr_output.json
    
    - name: Update index
      run: |
        python scripts/index_generator.py
    
    - name: Archive processed images
      run: |
        mkdir -p archive/$(date +%Y-%m-%d)
        if [ -n "$(ls -A notes-inbox/ 2>/dev/null)" ]; then
          mv notes-inbox/* archive/$(date +%Y-%m-%d)/ || true
        fi
    
    - name: Stage all changes
      run: |
        git add -A
        git status
    
    - name: Generate PR body and branch name
      id: pr_info
      run: |
        DETECTED_TAGS=""
        AVG_CONF=""
        FILE_COUNT=0
        NOTE_SUMMARY="notes"
        
        if [ -f /tmp/detected_tags.txt ]; then
          DETECTED_TAGS=$(cat /tmp/detected_tags.txt)
        fi
        
        if [ -f /tmp/avg_confidence.txt ]; then
          AVG_CONF=$(cat /tmp/avg_confidence.txt)
        fi
        
        if [ -f /tmp/formatting_results.json ]; then
          FILE_COUNT=$(python -c "import json; data=json.load(open('/tmp/formatting_results.json')); print(len(data['formatted_files']))" 2>/dev/null || echo "0")
        fi
        
        if [ -f /tmp/note_summary.txt ]; then
          NOTE_SUMMARY=$(cat /tmp/note_summary.txt)
          if [ -z "$NOTE_SUMMARY" ] || [ "$NOTE_SUMMARY" = "notes" ]; then
            NOTE_SUMMARY="update"
          fi
        fi
        
        # Set branch name and PR title
        CURRENT_DATE=$(date +%Y-%m-%d)
        PR_TITLE=$(date +"%B %d, %Y")
        BRANCH_NAME="notes-${CURRENT_DATE}-${NOTE_SUMMARY}"
        
        echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "pr_title=ðŸ“ Notes: ${PR_TITLE}" >> $GITHUB_OUTPUT
        echo "commit_date=${CURRENT_DATE}" >> $GITHUB_OUTPUT
        
        # Generate PR body
        cat > /tmp/pr_body.txt << 'EOFMARKER'
        ## ðŸ“ Processed Notes Summary

        **Date**: CURRENT_DATE_PLACEHOLDER
        **Files created**: FILE_COUNT_PLACEHOLDER
        **Average Confidence**: AVG_CONF_PLACEHOLDER

        ### ðŸ·ï¸ Topics Detected
        DETECTED_TAGS_PLACEHOLDER

        ### âœ… Review Checklist
        - [ ] OCR accuracy verified
        - [ ] Formatting looks correct
        - [ ] Cross-references work
        - [ ] No duplicate content

        ---
        *Auto-generated by NoteFlow*
        EOFMARKER
                
        # Replace placeholders
        sed -i "s|CURRENT_DATE_PLACEHOLDER|${CURRENT_DATE}|g" /tmp/pr_body.txt
        sed -i "s|FILE_COUNT_PLACEHOLDER|${FILE_COUNT}|g" /tmp/pr_body.txt
        sed -i "s|AVG_CONF_PLACEHOLDER|${AVG_CONF}|g" /tmp/pr_body.txt
        sed -i "s|DETECTED_TAGS_PLACEHOLDER|${DETECTED_TAGS}|g" /tmp/pr_body.txt
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ðŸ“ Add notes from ${{ steps.pr_info.outputs.commit_date }}"
        branch: ${{ steps.pr_info.outputs.branch_name }}
        delete-branch: true
        title: ${{ steps.pr_info.outputs.pr_title }}
        body-path: /tmp/pr_body.txt
        labels: notes, automated
        assignees: 5arjun
        add-paths: |
          Security-Plus/*.md
          archive/**/*
          README.md
          *.md
